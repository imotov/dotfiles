#!/bin/bash

# Downloads and installs elasticsearch for testing
#
# Usage:
# ES_VER=0.19.6 setup-es 

ES_VER=${ES_VER-"0.90.7"}
DOWNLOADS="${DOWNLOADS-$HOME/Downloads}"
DOWNLOADS="${DOWNLOADS%/}"
SOFTWARE_HOME="${SOFTWARE_HOME-$HOME/Software}"
SOFTWARE_HOME="${SOFTWARE_HOME%/}"
ES_NAME="elasticsearch-${ES_VER}"
ES_ARCHIVE="${ES_NAME}.tar.gz"
ES_ARCHIVE_PATH="${DOWNLOADS}/${ES_ARCHIVE}"
ES_HOME="${SOFTWARE_HOME}/${ES_NAME}"

cd ${SOFTWARE_HOME}

if [ ! -e "${ES_ARCHIVE_PATH}" ]
then
	echo "Downloading $ES_ARCHIVE"
	curl -f -L "https://download.elasticsearch.org/elasticsearch/elasticsearch/${ES_ARCHIVE}" -o ${ES_ARCHIVE_PATH}
	if [ $? -ne 0 ]
	then
		echo "Error downloading file"
		exit $?
	fi
		
fi

# Delete previous version of the elasticsearch if it exists
if [ -e "${ES_HOME}" ]
then
	rm -r "${ES_HOME}"
fi

tar -xzf "${ES_ARCHIVE_PATH}"

ES_CONFIG_FILE="${ES_HOME}/config/elasticsearch.yml"
echo '
############################ My Settings ####################################
network.host: "127.0.0.1"
cluster.name: "elasticsearch-imotov"
script.disable_dynamic: true
discovery.zen.ping.unicast.hosts: ["127.0.0.1:9300", "127.0.0.1:9301", "127.0.0.1:9302", "127.0.0.1:9303", "127.0.0.1:9304"]
discovery.zen.ping.multicast.enabled: false
path.repo: ["/var/folders", "/tmp"]
cluster.routing.allocation.disk.watermark.low: 90%
cluster.routing.allocation.disk.watermark.high: 95%
' >> ${ES_CONFIG_FILE}
echo 'Run: cd "'${ES_HOME}'"; bin/elasticsearch -f'



