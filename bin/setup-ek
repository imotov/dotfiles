#!/bin/bash

# Downloads and installs elasticsearch for testing
#
# Usage:
# ES_VER=2.3.1 KIBANA_VER=4.5.0 setup-ek

ES_VER=${ES_VER-"2.3.1"}
KIBANA_VER=${KIBANA_VER-"4.5.0"}
KIBANA_PLATFORM=${KIBANA_PLATFORM-"darwin-x64"}
DOWNLOADS="${DOWNLOADS-$HOME/Downloads}"
DOWNLOADS="${DOWNLOADS%/}"
SOFTWARE_HOME="${SOFTWARE_HOME-$HOME/Software}"
SOFTWARE_HOME="${SOFTWARE_HOME%/}"
# Elasticsearch
ES_NAME="elasticsearch-${ES_VER}"
ES_ARCHIVE="${ES_NAME}.tar.gz"
ES_ARCHIVE_PATH="${DOWNLOADS}/${ES_ARCHIVE}"
ES_HOME="${SOFTWARE_HOME}/${ES_NAME}"

# Kibana
KIBANA_NAME="kibana-${KIBANA_VER}-${KIBANA_PLATFORM}"
KIBANA_ARCHIVE="${KIBANA_NAME}.tar.gz"
KIBANA_ARCHIVE_PATH="${DOWNLOADS}/${KIBANA_ARCHIVE}"
KIBANA_HOME="${SOFTWARE_HOME}/${KIBANA_NAME}"

cd ${SOFTWARE_HOME}

if [ ! -e "${ES_ARCHIVE_PATH}" ]
then
	echo "Downloading $ES_ARCHIVE"
	curl -f -L "https://download.elasticsearch.org/elasticsearch/elasticsearch/${ES_ARCHIVE}" -o ${ES_ARCHIVE_PATH}
	if [ $? -ne 0 ]
	then
		echo "Error downloading file"
		exit $?
	fi

fi
if [ ! -e "${KIBANA_ARCHIVE_PATH}" ]
then
	echo "Downloading $KIBANA_ARCHIVE"
	curl -f -L "https://download.elasticsearch.org/kibana/kibana/${KIBANA_ARCHIVE}" -o ${KIBANA_ARCHIVE_PATH}
	if [ $? -ne 0 ]
	then
		echo "Error downloading file"
		exit $?
	fi

fi

# Delete previous version of the elasticsearch if it exists
if [ -e "${ES_HOME}" ]
then
	rm -r "${ES_HOME}"
fi

# Delete previous version of kibana if it exists
if [ -e "${KIBANA_HOME}" ]
then
	rm -r "${KIBANA_HOME}"
fi

tar -xzf "${ES_ARCHIVE_PATH}"

ES_CONFIG_FILE="${ES_HOME}/config/elasticsearch.yml"
echo '
############################ My Settings ####################################
cluster.name: "elasticsearch-imotov"
path.repo: ["/var/folders", "/tmp"]
cluster.routing.allocation.disk.watermark.low: 90%
cluster.routing.allocation.disk.watermark.high: 95%
' >> ${ES_CONFIG_FILE}

tar -xzf "${KIBANA_ARCHIVE_PATH}"

KIBANA_CONFIG_FILE="${KIBANA_HOME}/config/kibana.yml"
echo '
############################ My Settings ####################################
server.host: "127.0.0.1"
' >> ${KIBANA_CONFIG_FILE}

${KIBANA_HOME}/bin/kibana plugin --install elastic/sense

echo 'Elasticsearch in installed to '${ES_HOME}''
echo 'Kibana in installed to '${KIBANA_HOME}''
